<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster Web</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <audio id="backgroundMusic" autoplay loop>
        <source src="../data/music/music1.ogg" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div class="music-control">
        <button id="musicToggleBtn" class="music-btn" title="Toggle Music">
            üîä
        </button>
    </div>

    <div class="container">
        <div id="homeSection" class="section active">
            <div class="home-header">
                <h1>üéØ QuizMaster</h1>
                <p class="intro-text">Test Your Knowledge & Master New Topics</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <div class="home-features">
                <h2>Welcome to QuizMaster!</h2>
                <p style="color: #666; margin-bottom: 20px;">Get ready for an interactive quiz experience with:</p>
                <ul class="feature-list">
                    <li>Random quiz questions tailored for you</li>
                    <li>Search for specific quiz topics</li>
                    <li>Instant feedback on your answers</li>
                    <li>Detailed score breakdown</li>
                    <li>Review of incorrect answers</li>
                    <li>Progress tracking throughout the quiz</li>
                </ul>
            </div>

            <div class="search-section">
                <h2>Search for a Quiz</h2>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Enter quiz topic (e.g., 'Biology', 'Math', 'History')..." />
                    <button id="searchBtn">Search</button>
                </div>
                <div id="searchResults" style="display: none;"></div>
            </div>

            <div class="divider"></div>

            <div style="text-align: center;">
                <p style="color: #666; margin-bottom: 15px;">Or start with a random quiz</p>
                <button id="startQuizBtn">Start Random Quiz</button>
            </div>
        </div>

        <div id="quizSection" class="section">
            <div class="quiz-header">
                <div id="titleField"></div>
                <div class="score-display">
                    Question <span id="currentQuestion">1</span> of <span id="totalQuestions">0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div id="questionTextField"></div>

            <ul class="allAnswersList" id="answersList"></ul>
        </div>

        <div id="quickResultsSection" class="section">
            <div class="results-header">
                <h2>Quiz Complete! üéâ</h2>
                <div class="score-percentage" id="quickScorePercentage">0%</div>
                <div class="final-score" id="quickFinalScore">0/0</div>
                <div class="score-message" id="quickScoreMessage"></div>
            </div>

            <div class="button-group">
                <button id="viewResultsBtn">View Detailed Results</button>
                <button id="restartBtn">Restart Quiz</button>
            </div>
        </div>

        <div id="resultsSection" class="section">
            <div class="results-header">
                <h2>Your Quiz Results üìä</h2>
                <div class="score-percentage" id="scorePercentage">0%</div>
                <div class="final-score" id="finalScore">0/0</div>
                <div class="score-message" id="scoreMessage"></div>
            </div>

            <div class="performance-stats">
                <div class="stat-box correct">
                    <div class="stat-label">Correct Answers</div>
                    <div class="stat-value" id="correctCount">0</div>
                </div>
                <div class="stat-box incorrect">
                    <div class="stat-label">Incorrect Answers</div>
                    <div class="stat-value" id="incorrectCount">0</div>
                </div>
            </div>

            <div class="review-section" id="reviewSection" style="display: none;">
                <div class="review-title">Questions You Got Wrong</div>
                <div id="wrongAnswersReview"></div>
            </div>

            <div id="noWrongAnswers" style="text-align: center; padding: 30px; background: #e8f5e9; border-radius: 8px; display: none;">
                <div style="font-size: 48px; margin-bottom: 10px;">üèÜ</div>
                <div style="font-size: 18px; color: #2e7d32; font-weight: bold;">Perfect Score!</div>
                <div style="color: #666; margin-top: 10px;">You answered all questions correctly!</div>
            </div>

            <div class="button-row">
                <button id="homeBtn">Back to Home</button>
            </div>
        </div>
    </div>

    <script>
        const backgroundMusic = document.getElementById('backgroundMusic');
        const musicToggleBtn = document.getElementById('musicToggleBtn');
        let isMusicPlaying = true;

        backgroundMusic.volume = 0.3;

        musicToggleBtn.addEventListener('click', () => {
            if (isMusicPlaying) {
                backgroundMusic.pause();
                musicToggleBtn.textContent = 'üîá';
                musicToggleBtn.title = 'Unmute Music';
                isMusicPlaying = false;
            } else {
                backgroundMusic.play().catch(error => {
                    console.log('Autoplay was prevented:', error);
                });
                musicToggleBtn.textContent = 'üîä';
                musicToggleBtn.title = 'Mute Music';
                isMusicPlaying = true;
            }
        });

        backgroundMusic.play().catch(error => {
            console.log('Autoplay was prevented, user must click to start music');
            isMusicPlaying = false;
            musicToggleBtn.textContent = 'üîá';
        });

        backgroundMusic.addEventListener('ended', () => {
            backgroundMusic.currentTime = 0;
            backgroundMusic.play();
        });

        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let answered = false;
        let userAnswers = [];
        let currentQuizTitle = '';

        const startBtn = document.getElementById('startQuizBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('searchInput');
        const viewResultsBtn = document.getElementById('viewResultsBtn');
        const restartBtn = document.getElementById('restartBtn');
        const homeBtn = document.getElementById('homeBtn');

        const homeSection = document.getElementById('homeSection');
        const quizSection = document.getElementById('quizSection');
        const quickResultsSection = document.getElementById('quickResultsSection');
        const resultsSection = document.getElementById('resultsSection');

        const titleField = document.getElementById('titleField');
        const questionField = document.getElementById('questionTextField');
        const answersList = document.getElementById('answersList');
        const currentQuestionSpan = document.getElementById('currentQuestion');
        const totalQuestionsSpan = document.getElementById('totalQuestions');
        const progressFill = document.getElementById('progressFill');
        const errorMessage = document.getElementById('errorMessage');
        const searchResults = document.getElementById('searchResults');

        async function getQuizData() {
            try {
                const url = "http://127.0.0.1:8000/randomQuiz";
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching quiz data:', error);
                showError('Failed to load quiz. Please check your connection and try again.');
                throw error;
            }
        }

        async function getQuizByPath(filePath) {
            try {
                const url = `http://127.0.0.1:8000/getQuizByPath?path=${encodeURIComponent(filePath)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load quiz');
                }
                return data;
            } catch (error) {
                console.error('Error fetching quiz by path:', error);
                showError('Failed to load selected quiz. Please try again.');
                throw error;
            }
        }

        async function searchQuizzes() {
            const query = searchInput.value.trim();
            
            if (!query) {
                showError('Please enter a search term');
                return;
            }

            searchBtn.textContent = 'Searching...';
            searchBtn.disabled = true;
            hideError();

            try {
                const url = `http://127.0.0.1:8000/searchQuiz?query=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                displaySearchResults(data);
            } catch (error) {
                console.error('Error searching quizzes:', error);
                showError('Failed to search quizzes. Please check your connection and try again.');
            } finally {
                searchBtn.textContent = 'Search';
                searchBtn.disabled = false;
            }
        }

        function displaySearchResults(data) {
            const resultsContainer = searchResults;
            resultsContainer.innerHTML = '';

            if (!data.success || data.results.length === 0) {
                resultsContainer.innerHTML = `<div class="search-no-results">No quizzes found for "${searchInput.value}". Try a different search term.</div>`;
                resultsContainer.style.display = 'block';
                return;
            }

            resultsContainer.innerHTML = `<div class="search-header">${data.message}</div>`;

            const resultsList = document.createElement('div');
            resultsList.className = 'search-results-list';

            data.results.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                
                const title = document.createElement('h3');
                title.className = 'search-result-title';
                title.textContent = result.title;
                
                const questionCount = document.createElement('p');
                questionCount.className = 'search-result-info';
                questionCount.textContent = `${result.quiz.listOfQuestions ? result.quiz.listOfQuestions.length : 0} questions`;
                
                const selectBtn = document.createElement('button');
                selectBtn.className = 'search-result-btn';
                selectBtn.textContent = 'Start This Quiz';
                selectBtn.onclick = () => loadSelectedQuiz(result);
                
                resultItem.appendChild(title);
                resultItem.appendChild(questionCount);
                resultItem.appendChild(selectBtn);
                resultsList.appendChild(resultItem);
            });

            resultsContainer.appendChild(resultsList);
            resultsContainer.style.display = 'block';
        }

        async function loadSelectedQuiz(quizResult) {
            try {
                searchBtn.textContent = 'Loading...';
                searchBtn.disabled = true;

                const quizData = quizResult.quiz;
                const quizTitle = quizResult.title;

                if (!quizData || !quizData.listOfQuestions || quizData.listOfQuestions.length === 0) {
                    throw new Error('Invalid quiz data');
                }

                currentQuestionIndex = 0;
                score = 0;
                selectedAnswer = null;
                answered = false;
                userAnswers = [];
                currentQuizTitle = quizTitle;

                quizData_global = quizData.listOfQuestions;

                titleField.textContent = quizTitle;
                totalQuestionsSpan.textContent = quizData_global.length;

                showSection('quiz');
                displayQuestion();
                ensureMusicPlaying();

                searchBtn.textContent = 'Search';
                searchBtn.disabled = false;
            } catch (error) {
                console.error('Error loading selected quiz:', error);
                showError('Failed to load selected quiz. Please try again.');
                searchBtn.textContent = 'Search';
                searchBtn.disabled = false;
            }
        }

        let quizData_global = [];

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function showSection(sectionName) {
            homeSection.classList.remove('active');
            quizSection.classList.remove('active');
            quickResultsSection.classList.remove('active');
            resultsSection.classList.remove('active');

            switch (sectionName) {
                case 'home':
                    homeSection.classList.add('active');
                    break;
                case 'quiz':
                    quizSection.classList.add('active');
                    break;
                case 'quickResults':
                    quickResultsSection.classList.add('active');
                    break;
                case 'results':
                    resultsSection.classList.add('active');
                    break;
            }
        }

        function ensureMusicPlaying() {
            if (isMusicPlaying && backgroundMusic.paused) {
                backgroundMusic.play().catch(error => {
                    console.log('Could not resume music:', error);
                });
            }
        }

        async function startQuiz() {
            try {
                hideError();
                startBtn.textContent = 'Loading...';
                startBtn.disabled = true;

                const quizResponse = await getQuizData();
                
                const randomQuiz = quizResponse['randomQuiz'];
                const parsedData = JSON.parse(randomQuiz);
                quizData_global = parsedData['listOfQuestions'];
                const quizTitle = parsedData['title'];
                currentQuizTitle = quizTitle;

                if (!quizData_global || quizData_global.length === 0) {
                    throw new Error('No questions found in quiz');
                }

                currentQuestionIndex = 0;
                score = 0;
                selectedAnswer = null;
                answered = false;
                userAnswers = [];

                titleField.textContent = quizTitle;
                totalQuestionsSpan.textContent = quizData_global.length;

                showSection('quiz');
                displayQuestion();
                ensureMusicPlaying();

                startBtn.textContent = 'Start Random Quiz';
                startBtn.disabled = false;
            } catch (error) {
                console.error('Error starting quiz:', error);
                startBtn.textContent = 'Start Random Quiz';
                startBtn.disabled = false;
            }
        }

        function displayQuestion() {
            const question = quizData_global[currentQuestionIndex];
            
            questionField.textContent = question['question'];

            const answers = [
                question['correctAnswer'],
                ...question['wrongAnswers']
            ];

            const shuffledAnswers = shuffleArray(answers);

            answersList.innerHTML = '';

            shuffledAnswers.forEach((answer, index) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'answer-button';
                button.textContent = answer;
                button.dataset.answer = answer;
                button.onclick = () => selectAnswer(answer, button);
                li.appendChild(button);
                answersList.appendChild(li);
            });

            currentQuestionSpan.textContent = currentQuestionIndex + 1;
            const progress = ((currentQuestionIndex + 1) / quizData_global.length) * 100;
            progressFill.style.width = progress + '%';

            selectedAnswer = null;
            answered = false;
        }

        function selectAnswer(answer, buttonElement) {
            if (answered) return;

            answered = true;
            const question = quizData_global[currentQuestionIndex];
            const correctAnswer = question['correctAnswer'];
            const isCorrect = answer === correctAnswer;

            userAnswers.push({
                question: question['question'],
                correctAnswer: correctAnswer,
                userAnswer: answer,
                isCorrect: isCorrect
            });

            if (isCorrect) {
                score++;
            }

            document.querySelectorAll('.answer-button').forEach(btn => {
                btn.disabled = true;

                if (btn.dataset.answer === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn.dataset.answer === answer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            setTimeout(() => {
                currentQuestionIndex++;

                if (currentQuestionIndex < quizData_global.length) {
                    displayQuestion();
                    ensureMusicPlaying();
                } else {
                    showQuickResults();
                    ensureMusicPlaying();
                }
            }, 2000);
        }

        function showQuickResults() {
            const percentage = Math.round((score / quizData_global.length) * 100);
            document.getElementById('quickFinalScore').textContent = `${score}/${quizData_global.length}`;
            document.getElementById('quickScorePercentage').textContent = `${percentage}%`;

            let message = '';
            if (percentage === 100) {
                message = 'Perfect! You\'re a quiz master! üèÜ';
            } else if (percentage >= 80) {
                message = 'Excellent work! You really know your stuff! üåü';
            } else if (percentage >= 60) {
                message = 'Good job! Keep learning and you\'ll improve! üìö';
            } else {
                message = 'Keep practicing! Every attempt makes you smarter! üí™';
            }

            document.getElementById('quickScoreMessage').textContent = message;
            showSection('quickResults');
        }

        function showResults() {
            const percentage = Math.round((score / quizData_global.length) * 100);
            const incorrectCount = quizData_global.length - score;

            document.getElementById('finalScore').textContent = `${score}/${quizData_global.length}`;
            document.getElementById('scorePercentage').textContent = `${percentage}%`;
            document.getElementById('correctCount').textContent = score;
            document.getElementById('incorrectCount').textContent = incorrectCount;

            let message = '';
            if (percentage === 100) {
                message = 'Perfect! You\'re a quiz master! üèÜ';
            } else if (percentage >= 80) {
                message = 'Excellent work! You really know your stuff! üåü';
            } else if (percentage >= 60) {
                message = 'Good job! Keep learning and you\'ll improve! üìö';
            } else {
                message = 'Keep practicing! Every attempt makes you smarter! üí™';
            }

            document.getElementById('scoreMessage').textContent = `${message} (${percentage}% correct)`;

            const wrongAnswers = userAnswers.filter(answer => !answer.isCorrect);

            if (wrongAnswers.length > 0) {
                document.getElementById('reviewSection').style.display = 'block';
                document.getElementById('noWrongAnswers').style.display = 'none';
                displayWrongAnswersReview(wrongAnswers);
            } else {
                document.getElementById('reviewSection').style.display = 'none';
                document.getElementById('noWrongAnswers').style.display = 'block';
            }

            showSection('results');
        }

        function displayWrongAnswersReview(wrongAnswers) {
            const reviewContainer = document.getElementById('wrongAnswersReview');
            reviewContainer.innerHTML = '';

            wrongAnswers.forEach((answer, index) => {
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'question-review';

                const questionDiv = document.createElement('div');
                questionDiv.className = 'review-question';
                questionDiv.innerHTML = `<span style="color: #f44336;">‚úó</span> Question ${index + 1}: ${answer.question}`;

                const answersDiv = document.createElement('div');
                answersDiv.className = 'review-answers';

                const yourAnswerDiv = document.createElement('div');
                yourAnswerDiv.className = 'review-answer your-answer';
                yourAnswerDiv.innerHTML = `
                    <div class="review-answer-label">Your Answer:</div>
                    <div>${answer.userAnswer}</div>
                `;

                const correctAnswerDiv = document.createElement('div');
                correctAnswerDiv.className = 'review-answer correct-answer';
                correctAnswerDiv.innerHTML = `
                    <div class="review-answer-label">Correct Answer:</div>
                    <div>${answer.correctAnswer}</div>
                `;

                answersDiv.appendChild(yourAnswerDiv);
                answersDiv.appendChild(correctAnswerDiv);

                reviewDiv.appendChild(questionDiv);
                reviewDiv.appendChild(answersDiv);

                reviewContainer.appendChild(reviewDiv);
            });
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        startBtn.addEventListener('click', startQuiz);
        searchBtn.addEventListener('click', searchQuizzes);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchQuizzes();
            }
        });
        viewResultsBtn.addEventListener('click', showResults);
        restartBtn.addEventListener('click', startQuiz);
        homeBtn.addEventListener('click', () => {
            showSection('home');
            hideError();
            searchResults.style.display = 'none';
            searchInput.value = '';
        });
    </script>
</body>
</html>